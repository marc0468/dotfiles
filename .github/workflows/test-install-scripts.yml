name: Test install scripts

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          path: |
            setup.sh
            misc/install.sh

  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run scripts with stubs
        run: |
          set -euo pipefail
          export HOME="$(mktemp -d)"
          fakebin="$HOME/fakebin"
          mkdir -p "$fakebin"

          cat >"$fakebin/sudo" <<'EOF'
#!/usr/bin/env bash
echo "stub sudo $@" >&2
exec "$@"
EOF

          cat >"$fakebin/apt" <<'EOF'
#!/usr/bin/env bash
echo "stub apt $@" >&2
exit 0
EOF

          cat >"$fakebin/brew" <<'EOF'
#!/usr/bin/env bash
echo "stub brew $@" >&2
exit 0
EOF

          cat >"$fakebin/xcode-select" <<'EOF'
#!/usr/bin/env bash
echo "stub xcode-select $@" >&2
exit 0
EOF

          cat >"$fakebin/curl" <<'EOF'
#!/usr/bin/env bash
cat <<'SCRIPT'
#!/usr/bin/env bash
echo "stub mise installer"
exit 0
SCRIPT
EOF

          cat >"$fakebin/git" <<'EOF'
#!/usr/bin/env bash
echo "stub git $@" >&2
exit 0
EOF

          cat >"$fakebin/chsh" <<'EOF'
#!/usr/bin/env bash
echo "stub chsh $@" >&2
exit 0
EOF

          chmod +x "$fakebin"/*
          export PATH="$fakebin:$PATH"

          # Linux branch
          OSTYPE=linux-gnu HOME="$HOME" bash misc/install.sh

          # macOS branch
          OSTYPE=darwin HOME="$HOME" bash misc/install.sh

          # Dotfiles link setup
          HOME="$HOME" bash setup.sh
